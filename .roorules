# Otak Jinro ã‚·ã‚¹ãƒ†ãƒ ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³

## 1. ãƒ«ãƒ¼ãƒ ä½œæˆã¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å‚åŠ ãƒ•ãƒ­ãƒ¼

```mermaid
sequenceDiagram
    participant U as User (Browser)
    participant F as Frontend (Next.js - é€šå¸¸ãƒ‡ãƒ—ãƒ­ã‚¤)
    participant W as Workers (Cloudflare Workers)
    participant DO as Durable Object (GameRoom)
    participant KV as KV Storage

    Note over U,KV: ãƒ«ãƒ¼ãƒ ä½œæˆãƒ•ãƒ­ãƒ¼
    U->>F: ãƒ«ãƒ¼ãƒ ä½œæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    F->>W: POST /api/rooms (Cloudflare Workers)
    W->>DO: æ–°ã—ã„GameRoomã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ
    DO->>KV: ã‚²ãƒ¼ãƒ çŠ¶æ…‹ä¿å­˜
    DO-->>W: ãƒ«ãƒ¼ãƒ IDè¿”å´
    W-->>F: ãƒ«ãƒ¼ãƒ IDè¿”å´
    F-->>U: ãƒ«ãƒ¼ãƒ ä½œæˆå®Œäº†

    Note over U,KV: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å‚åŠ ãƒ•ãƒ­ãƒ¼
    U->>F: ãƒ«ãƒ¼ãƒ å‚åŠ  (roomId, playerName)
    F->>W: WebSocketæ¥ç¶šè¦æ±‚ (/api/rooms/{roomId}/ws)
    W->>DO: WebSocketæ¥ç¶šå‡¦ç†
    DO-->>F: WebSocketæ¥ç¶šç¢ºç«‹
    F->>DO: join_room ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
    DO->>DO: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¿½åŠ å‡¦ç†
    DO->>KV: ã‚²ãƒ¼ãƒ çŠ¶æ…‹æ›´æ–°
    DO->>F: game_state_update ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ
    F->>U: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆæ›´æ–°è¡¨ç¤º
```

## 2. ã‚²ãƒ¼ãƒ é–‹å§‹ã¨é€²è¡Œãƒ•ãƒ­ãƒ¼

```mermaid
sequenceDiagram
    participant H as Host Player
    participant F as Frontend
    participant DO as Durable Object
    participant AI as AI Players
    participant P as Other Players

    Note over H,P: ã‚²ãƒ¼ãƒ é–‹å§‹
    H->>F: ã‚²ãƒ¼ãƒ é–‹å§‹ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
    F->>DO: start_game ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    DO->>DO: å½¹è·å‰²ã‚Šå½“ã¦ (assignRoles)
    DO->>DO: ãƒ•ã‚§ãƒ¼ã‚ºã‚’'day'ã«è¨­å®š
    DO->>DO: ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
    DO->>F: game_state_update (å…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«)
    F->>H: ã‚²ãƒ¼ãƒ ç”»é¢è¡¨ç¤º
    F->>P: ã‚²ãƒ¼ãƒ ç”»é¢è¡¨ç¤º

    Note over H,P: æ˜¼ãƒ•ã‚§ãƒ¼ã‚º
    loop æ˜¼ã®è­°è«–æ™‚é–“
        P->>F: ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›
        F->>DO: chat ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        DO->>F: ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ
        F->>P: ãƒãƒ£ãƒƒãƒˆè¡¨ç¤ºæ›´æ–°
        
        alt AIãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è‡ªå‹•ç™ºè¨€
            DO->>AI: AIç™ºè¨€ãƒˆãƒªã‚¬ãƒ¼
            AI->>DO: è‡ªå‹•ç”Ÿæˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            DO->>F: ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ
        end
    end

    Note over H,P: æŠ•ç¥¨ãƒ•ã‚§ãƒ¼ã‚º
    DO->>DO: ãƒ•ã‚§ãƒ¼ã‚ºã‚’'voting'ã«å¤‰æ›´
    DO->>F: game_state_update
    F->>P: æŠ•ç¥¨UIè¡¨ç¤º
    
    loop å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æŠ•ç¥¨
        P->>F: æŠ•ç¥¨å¯¾è±¡é¸æŠ
        F->>DO: vote ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        DO->>DO: æŠ•ç¥¨è¨˜éŒ²
        DO->>F: æŠ•ç¥¨çŠ¶æ³æ›´æ–°
    end
    
    DO->>DO: æŠ•ç¥¨çµæœé›†è¨ˆ
    DO->>DO: å‡¦åˆ‘å¯¾è±¡æ±ºå®š
    DO->>F: å‡¦åˆ‘çµæœãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ
```

## 3. å¤œãƒ•ã‚§ãƒ¼ã‚ºã¨èƒ½åŠ›ä½¿ç”¨ãƒ•ãƒ­ãƒ¼

```mermaid
sequenceDiagram
    participant W as Werewolf
    participant S as Seer
    participant M as Medium
    participant F as Frontend
    participant DO as Durable Object

    Note over W,DO: å¤œãƒ•ã‚§ãƒ¼ã‚ºé–‹å§‹
    DO->>DO: ãƒ•ã‚§ãƒ¼ã‚ºã‚’'night'ã«å¤‰æ›´
    DO->>F: game_state_update
    F->>W: äººç‹¼ç”¨UIè¡¨ç¤º
    F->>S: å ã„å¸«ç”¨UIè¡¨ç¤º
    F->>M: éœŠåª’å¸«ç”¨UIè¡¨ç¤º

    Note over W,DO: èƒ½åŠ›ä½¿ç”¨
    par äººç‹¼ã®è¥²æ’ƒ
        W->>F: è¥²æ’ƒå¯¾è±¡é¸æŠ
        F->>DO: use_ability (attack)
        DO->>DO: è¥²æ’ƒå¯¾è±¡è¨˜éŒ²
        DO->>F: ability_used ç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    and å ã„å¸«ã®å ã„
        S->>F: å ã„å¯¾è±¡é¸æŠ
        F->>DO: use_ability (divine)
        DO->>DO: å ã„å®Ÿè¡Œ
        DO->>F: divine_result (å ã„å¸«ã®ã¿)
    and éœŠåª’å¸«ã®éœŠåª’
        alt å‰æ—¥å‡¦åˆ‘è€…ãŒã„ã‚‹å ´åˆ
            DO->>DO: éœŠåª’çµæœè¨ˆç®—
            DO->>F: medium_result (éœŠåª’å¸«ã®ã¿)
        end
    end

    Note over W,DO: å¤œãƒ•ã‚§ãƒ¼ã‚ºçµ‚äº†
    DO->>DO: å¤œã®çµæœå‡¦ç†
    DO->>DO: è¥²æ’ƒå®Ÿè¡Œ
    DO->>DO: å‹åˆ©æ¡ä»¶ãƒã‚§ãƒƒã‚¯
    alt ã‚²ãƒ¼ãƒ ç¶™ç¶š
        DO->>DO: æ¬¡ã®æ˜¼ãƒ•ã‚§ãƒ¼ã‚ºã¸
        DO->>F: game_state_update
    else ã‚²ãƒ¼ãƒ çµ‚äº†
        DO->>DO: ãƒ•ã‚§ãƒ¼ã‚ºã‚’'ended'ã«è¨­å®š
        DO->>F: ã‚²ãƒ¼ãƒ çµ‚äº†çµæœãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ
        F->>W: ã‚²ãƒ¼ãƒ çµ‚äº†ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        F->>S: ã‚²ãƒ¼ãƒ çµ‚äº†ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        F->>M: ã‚²ãƒ¼ãƒ çµ‚äº†ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
    end
```

## 4. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨WebSocketç®¡ç†

```mermaid
sequenceDiagram
    participant U as User
    participant F as Frontend
    participant W as Workers
    participant DO as Durable Object

    Note over U,DO: WebSocketæ¥ç¶šã‚¨ãƒ©ãƒ¼
    U->>F: ãƒšãƒ¼ã‚¸ã‚¢ã‚¯ã‚»ã‚¹
    F->>F: åˆæœŸåŒ–çŠ¶æ…‹è¨­å®š (isInitializing=true)
    F->>U: ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º ("ãƒ«ãƒ¼ãƒ ã«æ¥ç¶šä¸­...")
    F->>W: WebSocketæ¥ç¶šè©¦è¡Œ (100msé…å»¶å¾Œ)
    alt æ¥ç¶šå¤±æ•—
        W-->>F: æ¥ç¶šã‚¨ãƒ©ãƒ¼
        F->>F: delayedErrorè¨­å®š (500msé…å»¶)
        F->>U: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        F->>F: å†æ¥ç¶šè©¦è¡Œ
    else æ¥ç¶šæˆåŠŸ
        W->>DO: WebSocketç¢ºç«‹
        DO-->>F: æ¥ç¶šç¢ºèª
        F->>F: åˆæœŸåŒ–å®Œäº† (isInitializing=false)
        F->>U: ã‚²ãƒ¼ãƒ ç”»é¢è¡¨ç¤º
    end

    Note over U,DO: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é›¢è„±å‡¦ç†
    U->>F: ãƒšãƒ¼ã‚¸é›¢è„±/ãƒ–ãƒ©ã‚¦ã‚¶é–‰ã˜ã‚‹
    F->>DO: WebSocketåˆ‡æ–­
    DO->>DO: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å‰Šé™¤
    DO->>DO: ã‚²ãƒ¼ãƒ çŠ¶æ…‹æ›´æ–°
    DO->>F: player_left ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ
    F->>U: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆæ›´æ–°

    Note over U,DO: ç„¡åŠ¹ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†
    U->>F: ä¸æ­£ãªæ“ä½œ
    F->>DO: ç„¡åŠ¹ãªWebSocketãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    DO->>DO: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¤±æ•—
    DO->>F: error ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    F->>U: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
```

## 5. AI ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å‹•ä½œãƒ•ãƒ­ãƒ¼

```mermaid
sequenceDiagram
    participant H as Host
    participant F as Frontend
    participant DO as Durable Object
    participant AI as AI Logic
    participant OpenAI as OpenAI API

    Note over H,OpenAI: AIãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¿½åŠ 
    H->>F: AIãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¿½åŠ ãƒœã‚¿ãƒ³
    F->>DO: AIå‚åŠ ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    DO->>DO: AIãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½œæˆ
    DO->>F: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆæ›´æ–°

    Note over H,OpenAI: AIè‡ªå‹•ç™ºè¨€
    loop ã‚²ãƒ¼ãƒ é€²è¡Œä¸­
        DO->>DO: 35ç§’é–“éš”ãƒã‚§ãƒƒã‚¯
        alt ç™ºè¨€æ¡ä»¶æº€ãŸã™
            DO->>AI: ç™ºè¨€ç”Ÿæˆè¦æ±‚
            AI->>OpenAI: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé€ä¿¡
            OpenAI-->>AI: ç”Ÿæˆãƒ†ã‚­ã‚¹ãƒˆ
            AI->>DO: ç™ºè¨€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            DO->>F: ãƒãƒ£ãƒƒãƒˆãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ
        end
    end

    Note over H,OpenAI: AIæŠ•ç¥¨ãƒ»èƒ½åŠ›ä½¿ç”¨
    alt æŠ•ç¥¨ãƒ•ã‚§ãƒ¼ã‚º
        DO->>AI: æŠ•ç¥¨åˆ¤æ–­è¦æ±‚
        AI->>AI: ãƒ©ãƒ³ãƒ€ãƒ é¸æŠãƒ­ã‚¸ãƒƒã‚¯
        AI->>DO: æŠ•ç¥¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    else å¤œãƒ•ã‚§ãƒ¼ã‚ºï¼ˆäººç‹¼AIï¼‰
        DO->>AI: è¥²æ’ƒå¯¾è±¡é¸æŠè¦æ±‚
        AI->>AI: ãƒ©ãƒ³ãƒ€ãƒ é¸æŠãƒ­ã‚¸ãƒƒã‚¯
        AI->>DO: èƒ½åŠ›ä½¿ç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    end
```

## ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆè¦ç´ 

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ (Next.js)
- **å½¹å‰²**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã€WebSocketé€šä¿¡ç®¡ç†
- **ä¸»è¦ãƒ•ã‚¡ã‚¤ãƒ«**:
  - `packages/frontend/src/app/page.tsx` - ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ï¼ˆãƒ«ãƒ¼ãƒ ä½œæˆï¼‰
  - `packages/frontend/src/app/layout.tsx` - ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
  - `packages/frontend/src/app/room/[roomId]/page.tsx` - ãƒ«ãƒ¼ãƒ ãƒšãƒ¼ã‚¸
  - `packages/frontend/src/app/room/[roomId]/page.test.tsx` - ãƒ«ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ãƒ†ã‚¹ãƒˆ
  - `packages/frontend/src/lib/openai.ts` - OpenAI APIçµ±åˆ
  - `packages/frontend/src/lib/utils.ts` - ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
  - `packages/frontend/src/lib/avatars.tsx` - ã‚¢ãƒã‚¿ãƒ¼ç®¡ç†
- **UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ**:
  - `packages/frontend/src/components/ui/button.tsx`
  - `packages/frontend/src/components/ui/card.tsx`
  - `packages/frontend/src/components/ui/input.tsx`
  - `packages/frontend/src/components/ui/label.tsx`
  - `packages/frontend/src/components/ui/modal.tsx`
  - `packages/frontend/src/components/ui/tabs.tsx`
- **ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«**:
  - `packages/frontend/src/lib/__tests__/utils.test.ts`
  - `packages/frontend/src/lib/__tests__/utils.pbt.test.ts`

### ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚º (Cloudflare Workers)
- **å½¹å‰²**: API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã€WebSocket ãƒ—ãƒ­ã‚­ã‚·
- **ä¸»è¦ãƒ•ã‚¡ã‚¤ãƒ«**:
  - `packages/workers/src/index.ts` - ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
  - `packages/workers/src/gameRoom.ts` - Durable Objectå®Ÿè£…
  - `packages/workers/src/types.ts` - å‹å®šç¾©
  - `packages/workers/src/utils.ts` - ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
  - `packages/workers/wrangler.toml` - Cloudflareè¨­å®š
- **ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«**:
  - `packages/workers/src/__tests__/gameRoom.test.ts` - 19ãƒ†ã‚¹ãƒˆï¼ˆ100%æˆåŠŸï¼‰
  - `packages/workers/src/__tests__/utils.test.ts` - 21ãƒ†ã‚¹ãƒˆï¼ˆ100%æˆåŠŸï¼‰
  - `packages/workers/src/__tests__/gameRoom.pbt.test.ts` - Property-Based Testing
  - `packages/workers/src/__tests__/setup.ts` - ãƒ†ã‚¹ãƒˆç’°å¢ƒè¨­å®š

### å…±æœ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
- **å½¹å‰²**: å‹å®šç¾©ã€ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯
- **ä¸»è¦ãƒ•ã‚¡ã‚¤ãƒ«**:
  - `packages/shared/src/index.ts` - ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®šç¾©
  - `packages/shared/src/types/game.ts` - ã‚²ãƒ¼ãƒ å‹å®šç¾©
  - `packages/shared/src/utils/gameUtils.ts` - ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆå½¹è·å‰²ã‚Šå½“ã¦ã€å‹åˆ©æ¡ä»¶åˆ¤å®šã€æŠ•ç¥¨å‡¦ç†ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ¤œè¨¼ãªã©ï¼‰
- **ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«**:
  - `packages/shared/src/utils/__tests__/gameUtils.test.ts`
  - `packages/shared/src/utils/__tests__/gameUtils.pbt.test.ts`

### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
- **ãƒ«ãƒ¼ãƒˆãƒ¬ãƒ™ãƒ«**:
  - `package.json` - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¾å­˜é–¢ä¿‚
  - `package-lock.json` - ä¾å­˜é–¢ä¿‚ãƒ­ãƒƒã‚¯ãƒ•ã‚¡ã‚¤ãƒ«
  - `turbo.json` - Turborepoè¨­å®š
  - `.gitignore` - Gité™¤å¤–è¨­å®š
  - `README.md` - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆèª¬æ˜
  - `.roorules` - ã‚·ã‚¹ãƒ†ãƒ ä»•æ§˜æ›¸
- **é–‹ç™ºã‚¹ã‚¯ãƒªãƒ—ãƒˆ**:
  - `start-dev.ps1` - é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•
  - `test-api.ps1` - API ãƒ†ã‚¹ãƒˆ
  - `watch-logs.ps1` - ãƒ­ã‚°ç›£è¦–
- **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**:
  - `docs/PBT_GUIDE.md` - Property-Based Testing ã‚¬ã‚¤ãƒ‰
- **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰è¨­å®š**:
  - `packages/frontend/package.json` - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ä¾å­˜é–¢ä¿‚
  - `packages/frontend/next.config.js` - Next.jsè¨­å®š
  - `packages/frontend/tailwind.config.js` - Tailwind CSSè¨­å®š
  - `packages/frontend/postcss.config.js` - PostCSSè¨­å®š
  - `packages/frontend/tsconfig.json` - TypeScriptè¨­å®š
  - `packages/frontend/jest.config.js` - Jestè¨­å®š
  - `packages/frontend/jest.setup.js` - Jestã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
  - `packages/frontend/next-env.d.ts` - Next.jså‹å®šç¾©
  - `packages/frontend/.env.example` - ç’°å¢ƒå¤‰æ•°ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
  - `packages/frontend/src/app/globals.css` - ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚¿ã‚¤ãƒ«
- **ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚ºè¨­å®š**:
  - `packages/workers/package.json` - ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚ºä¾å­˜é–¢ä¿‚
  - `packages/workers/tsconfig.json` - TypeScriptè¨­å®š
  - `packages/workers/jest.config.js` - Jestè¨­å®š
- **å…±æœ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒªè¨­å®š**:
  - `packages/shared/package.json` - å…±æœ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒªä¾å­˜é–¢ä¿‚
  - `packages/shared/tsconfig.json` - TypeScriptè¨­å®š
  - `packages/shared/jest.config.js` - Jestè¨­å®š

## WebSocket ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä»•æ§˜

### ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ â†’ ã‚µãƒ¼ãƒãƒ¼
- `join_room`: ãƒ«ãƒ¼ãƒ å‚åŠ 
- `leave_room`: ãƒ«ãƒ¼ãƒ é›¢è„±
- `start_game`: ã‚²ãƒ¼ãƒ é–‹å§‹
- `vote`: æŠ•ç¥¨
- `chat`: ãƒãƒ£ãƒƒãƒˆé€ä¿¡
- `use_ability`: èƒ½åŠ›ä½¿ç”¨

### ã‚µãƒ¼ãƒãƒ¼ â†’ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
- `game_state_update`: ã‚²ãƒ¼ãƒ çŠ¶æ…‹æ›´æ–°
- `player_joined`: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å‚åŠ é€šçŸ¥
- `player_left`: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é›¢è„±é€šçŸ¥
- `divine_result`: å ã„çµæœ
- `medium_result`: éœŠåª’çµæœ
- `ability_used`: èƒ½åŠ›ä½¿ç”¨ç¢ºèª
- `error`: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

# Otak Jinro ã‚·ã‚¹ãƒ†ãƒ ã‚¯ãƒ©ã‚¹å›³

## 1. ã‚²ãƒ¼ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£

```mermaid
classDiagram
    class Player {
        +string id
        +string name
        +PlayerRole role
        +boolean isAlive
        +boolean isHost
        +boolean isReady
        +AIPersonality? aiPersonality
    }

    class GameState {
        +string id
        +GamePhase phase
        +Player[] players
        +number currentDay
        +number timeRemaining
        +Vote[] votes
        +ChatMessage[] chatMessages
        +NightAction[] nightActions
        +Player? lastExecuted
        +string? winner
    }

    class ChatMessage {
        +string id
        +string playerId
        +string playerName
        +string content
        +number timestamp
        +string type
    }

    class Vote {
        +string voterId
        +string targetId
        +number timestamp
    }

    class NightAction {
        +string playerId
        +ActionType type
        +string? targetId
        +number timestamp
    }

    class AIPersonality {
        +string name
        +string description
        +string[] traits
        +string speakingStyle
        +number aggressiveness
        +number suspicion
        +number cooperation
        +number stress
        +number confidence
        +string[] suspectedPlayers
        +string[] trustedPlayers
    }

    GameState ||--o{ Player : contains
    GameState ||--o{ ChatMessage : contains
    GameState ||--o{ Vote : contains
    GameState ||--o{ NightAction : contains
    Player ||--o| AIPersonality : has
    Vote }o--|| Player : voter
    Vote }o--|| Player : target
    NightAction }o--|| Player : actor
    ChatMessage }o--|| Player : sender
```

## 2. ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚¯ãƒ©ã‚¹å›³

```mermaid
classDiagram
    class GameRoom {
        -DurableObjectState state
        -GameState gameState
        -Map~string,CloudflareWebSocket~ websockets
        -Map~string,any~ timers
        +fetch(Request) Promise~Response~
        -handleWebSocket(Request) Promise~Response~
        -handleRoomAPI(Request) Promise~Response~
        -handleWebSocketMessage(string, CloudflareWebSocket) void
        -broadcastToAll(object) void
        -broadcastToPlayer(string, object) void
        -saveGameState() Promise~void~
        -loadGameState() Promise~void~
        -startGame() void
        -processVote(Vote) void
        -processNightActions() void
        -checkWinCondition() string?
        -addAIPlayer() void
        -handleAIActions() void
        -assignRoles(Player[], PlayerRole[]?) Player[]
        -getDefaultRoles(number) PlayerRole[]
        -countVotes(Vote[]) object[]
        -getExecutionTarget(Vote[]) string?
        -canPlayerAct(Player, GameState, string) boolean
        -generateRoomId() string
        -validatePlayerName(string) boolean
        -getTeamMembers(Player[], string) Player[]
        -isAIPlayer(string) boolean
        -generateAIPersonality(string) Promise~AIPersonality~
        -generateAIResponse(string, GameState, AIPersonality) Promise~string~
        -moderateMessage(string) Promise~boolean~
        -determineAIResponse(GameState, Player) Promise~string~
        -updateEmotionalState(Player, GameState) AIPersonality
    }

    class RoomPage {
        -GameState gameState
        -boolean isConnected
        -string error
        -boolean isInitializing
        -string delayedError
        -WebSocket ws
        -string[] chatMessages
        +useEffect() void
        +connectWebSocket() void
        +sendMessage(object) void
        +handleVote(string) void
        +handleChat(string) void
        +handleAbility(string, string) void
        +addAIPlayer() void
        +startGame() void
        +validateParameters() void
        +handleDelayedError() void
    }

    class GameUtils {
        +assignRoles(Player[], PlayerRole[]?) Player[]
        +getDefaultRoles(number) PlayerRole[]
        +checkWinCondition(Player[]) string?
        +countVotes(Vote[]) object[]
        +getExecutionTarget(Vote[]) string?
        +canPlayerAct(Player, GameState, string) boolean
        +generateRoomId() string
        +validatePlayerName(string) boolean
        +getTeamMembers(Player[], string) Player[]
    }

    class OpenAIService {
        +generateAIPersonality(string) Promise~AIPersonality~
        +generateAIResponse(string, GameState, AIPersonality) Promise~string~
        +moderateMessage(string) Promise~boolean~
        +determineAIResponse(GameState, Player) Promise~string~
        +updateEmotionalState(Player, GameState) AIPersonality
        +validateApiKey(string) boolean
        +testApiKey(string) Promise~boolean~
    }

    class WorkersAPI {
        +handleRequest(Request) Promise~Response~
        +handleWebSocketUpgrade(Request) Promise~Response~
        +createRoom() Promise~Response~
        +getRoomInfo(string) Promise~Response~
    }

    GameRoom ||--|| GameState : manages
    GameRoom ||--o{ CloudflareWebSocket : handles
    RoomPage ||--|| WebSocket : uses
    RoomPage ||--|| GameState : displays
    GameUtils ..> Player : operates on
    GameUtils ..> Vote : analyzes
    OpenAIService ..> AIPersonality : generates
    OpenAIService ..> Player : enhances
    GameRoom ||--|| GameUtils : uses
    GameRoom ||--|| OpenAIService : uses
    WorkersAPI ||--|| GameRoom : delegates to
```

## 3. WebSocketãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¯ãƒ©ã‚¹å›³

```mermaid
classDiagram
    class WebSocketMessage {
        <<abstract>>
        +string type
        +any data
        +number timestamp
    }

    class ClientMessage {
        <<abstract>>
    }

    class ServerMessage {
        <<abstract>>
    }

    class JoinRoomMessage {
        +string type = "join_room"
        +string playerName
        +string roomId
    }

    class LeaveRoomMessage {
        +string type = "leave_room"
    }

    class StartGameMessage {
        +string type = "start_game"
    }

    class VoteMessage {
        +string type = "vote"
        +string targetId
    }

    class ChatMessage {
        +string type = "chat"
        +string content
    }

    class UseAbilityMessage {
        +string type = "use_ability"
        +string abilityType
        +string? targetId
    }

    class GameStateUpdateMessage {
        +string type = "game_state_update"
        +GameState gameState
    }

    class PlayerJoinedMessage {
        +string type = "player_joined"
        +Player player
    }

    class PlayerLeftMessage {
        +string type = "player_left"
        +string playerId
    }

    class DivineResultMessage {
        +string type = "divine_result"
        +string targetId
        +boolean isWerewolf
    }

    class MediumResultMessage {
        +string type = "medium_result"
        +string targetId
        +boolean isWerewolf
    }

    class AbilityUsedMessage {
        +string type = "ability_used"
        +string abilityType
        +boolean success
    }

    class ErrorMessage {
        +string type = "error"
        +string message
        +string? code
    }

    WebSocketMessage <|-- ClientMessage
    WebSocketMessage <|-- ServerMessage
    
    ClientMessage <|-- JoinRoomMessage
    ClientMessage <|-- LeaveRoomMessage
    ClientMessage <|-- StartGameMessage
    ClientMessage <|-- VoteMessage
    ClientMessage <|-- ChatMessage
    ClientMessage <|-- UseAbilityMessage
    
    ServerMessage <|-- GameStateUpdateMessage
    ServerMessage <|-- PlayerJoinedMessage
    ServerMessage <|-- PlayerLeftMessage
    ServerMessage <|-- DivineResultMessage
    ServerMessage <|-- MediumResultMessage
    ServerMessage <|-- AbilityUsedMessage
    ServerMessage <|-- ErrorMessage
```

## 4. ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã¨ãƒ˜ãƒ«ãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¹å›³

```mermaid
classDiagram
    class GameUtils {
        +assignRoles(players: Player[], customRoles?: PlayerRole[]) Player[]
        +getDefaultRoles(playerCount: number) PlayerRole[]
        +checkWinCondition(players: Player[]) string | null
        +countVotes(votes: Vote[]) object[]
        +getExecutionTarget(votes: Vote[]) string | null
        +canPlayerAct(player: Player, gameState: GameState, action: string) boolean
        +generateRoomId() string
        +validatePlayerName(name: string) boolean
        +getTeamMembers(players: Player[], team: string) Player[]
    }

    class AIConstants {
        +AI_NAMES: string[]
        +isAIPlayer(playerName: string) boolean
    }

    GameUtils ..> Player : validates
    GameUtils ..> Vote : analyzes
    AIConstants ..> Player : identifies
```

## ã‚¯ãƒ©ã‚¹é–¢ä¿‚ã®èª¬æ˜

### ä¸»è¦ãªé–¢ä¿‚æ€§
1. **GameRoom** ã¯ä¸­å¤®ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã¨ã—ã¦æ©Ÿèƒ½ã—ã€GameStateã‚’ç®¡ç†ã—ã€WebSocketæ¥ç¶šã‚’å‡¦ç†
2. **GameState** ã¯ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã‚’ä¿æŒã—ã€Playerã€ChatMessageã€Voteã€NightActionã‚’é›†ç´„
3. **Player** ã¯å€‹ã€…ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¡¨ç¾ã—ã€AIPersonalityã‚’æŒã¤å ´åˆãŒã‚ã‚‹
4. **WebSocketMessage** ã®éšå±¤ã¯ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ»ã‚µãƒ¼ãƒãƒ¼é–“ã®é€šä¿¡ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’å®šç¾©
5. **GameUtils** ã¯å…±æœ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã—ã¦ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯é–¢æ•°ã‚’æä¾›
6. **OpenAIService** ã¯AIæ©Ÿèƒ½ã‚’æä¾›ã—ã€GameRoomã‹ã‚‰åˆ©ç”¨ã•ã‚Œã‚‹

### è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³
- **Durable Object Pattern**: GameRoomãŒã‚¹ãƒ†ãƒ¼ãƒˆãƒ•ãƒ«ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦å‹•ä½œ
- **Observer Pattern**: WebSocketã‚’é€šã˜ãŸãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡
- **Strategy Pattern**: AIPersonalityã«ã‚ˆã‚‹ç•°ãªã‚‹è¡Œå‹•ãƒ‘ã‚¿ãƒ¼ãƒ³
- **Command Pattern**: WebSocketMessageã«ã‚ˆã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
- **Utility Pattern**: GameUtilsã«ã‚ˆã‚‹å…±æœ‰ãƒ­ã‚¸ãƒƒã‚¯æä¾›

## å®Ÿè£…ã®è©³ç´°

### AI ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ©Ÿèƒ½
- **AIåå‰ã®å®šæ•°**: `['ã‚¢ãƒªã‚¹', 'ãƒœãƒ–', 'ãƒãƒ£ãƒ¼ãƒªãƒ¼', 'ãƒ€ã‚¤ã‚¢ãƒŠ', 'ã‚¤ãƒ–', 'ãƒ•ãƒ©ãƒ³ã‚¯', 'ã‚°ãƒ¬ãƒ¼ã‚¹', 'ãƒ˜ãƒ³ãƒªãƒ¼', 'ã‚¢ã‚¤ãƒ“ãƒ¼', 'ã‚¸ãƒ£ãƒƒã‚¯', 'ã‚±ã‚¤ãƒˆ', 'ãƒ«ãƒ¼ã‚¯']`
- **AIåˆ¤å®šé–¢æ•°**: `isAIPlayer(playerName: string)` ã§AIãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‹ã©ã†ã‹ã‚’åˆ¤å®š
- **OpenAIçµ±åˆ**: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚ºã®ä¸¡æ–¹ã§OpenAI APIã‚’åˆ©ç”¨
- **AIè‡ªå‹•ç™ºè¨€**: 35ç§’é–“éš”ã§AIãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒè‡ªå‹•çš„ã«ç™ºè¨€
- **AIæŠ•ç¥¨ãƒ»èƒ½åŠ›ä½¿ç”¨**: ãƒ©ãƒ³ãƒ€ãƒ é¸æŠãƒ­ã‚¸ãƒƒã‚¯ã«ã‚ˆã‚‹è‡ªå‹•è¡Œå‹•

### ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯é–¢æ•°
- **å½¹è·å‰²ã‚Šå½“ã¦**: `assignRoles()` - ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«å½¹è·ã‚’ãƒ©ãƒ³ãƒ€ãƒ å‰²ã‚Šå½“ã¦
- **å‹åˆ©æ¡ä»¶åˆ¤å®š**: `checkWinCondition()` - æ‘äººå‹åˆ©/äººç‹¼å‹åˆ©ã®åˆ¤å®š
- **æŠ•ç¥¨å‡¦ç†**: `countVotes()`, `getExecutionTarget()` - æŠ•ç¥¨é›†è¨ˆã¨å‡¦åˆ‘å¯¾è±¡æ±ºå®š
- **ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ¤œè¨¼**: `validatePlayerName()` - ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯
- **ãƒãƒ¼ãƒ åˆ†ã‘**: `getTeamMembers()` - æ‘äººãƒãƒ¼ãƒ /äººç‹¼ãƒãƒ¼ãƒ ã®å–å¾—

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…
- **WebSocketç®¡ç†**: æ¥ç¶šçŠ¶æ…‹ã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã€å†æ¥ç¶šæ©Ÿèƒ½
- **UIçŠ¶æ…‹ç®¡ç†**: React Hooksã«ã‚ˆã‚‹çŠ¶æ…‹ç®¡ç†
- **ã‚¿ã‚¤ãƒãƒ¼æ©Ÿèƒ½**: ã‚²ãƒ¼ãƒ ãƒ•ã‚§ãƒ¼ã‚ºã”ã¨ã®åˆ¶é™æ™‚é–“è¡¨ç¤º
- **ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½**: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°
- **æŠ•ç¥¨ãƒ»èƒ½åŠ›ä½¿ç”¨UI**: ãƒ•ã‚§ãƒ¼ã‚ºã«å¿œã˜ãŸã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…
- **Durable Object**: ã‚¹ãƒ†ãƒ¼ãƒˆãƒ•ãƒ«ãªã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ ç®¡ç†
- **WebSocketé€šä¿¡**: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæ–¹å‘é€šä¿¡
- **KV Storage**: ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã®æ°¸ç¶šåŒ–
- **AIçµ±åˆ**: OpenAI APIã«ã‚ˆã‚‹è‡ªå‹•ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼

## ãƒ†ã‚¹ãƒˆå®Ÿè£…ã®è©³ç´°

### ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆå®Œå…¨å®Ÿè£…çŠ¶æ³

#### Workers ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ - å¤§å¹…æ”¹å–„é”æˆ
- **Test Suites**: 2 passed, 2 total
- **Tests**: 40 passed, 40 total (å…¨ãƒ†ã‚¹ãƒˆæˆåŠŸ!)
- **ã‚«ãƒãƒ¬ãƒƒã‚¸**:
  - `utils.ts`: **100%å®Œå…¨ã‚«ãƒãƒ¬ãƒƒã‚¸é”æˆ** ğŸ‰
  - `gameRoom.ts`: 4.63%ã‚«ãƒãƒ¬ãƒƒã‚¸ (åŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆå®Œäº†)

#### å®Ÿè£…ã•ã‚ŒãŸãƒ†ã‚¹ãƒˆæ©Ÿèƒ½
1. **å®Œå…¨ãªWebSocketãƒ†ã‚¹ãƒˆå®Ÿè£…**: MockWebSocketã€WebSocketPairã®å®Œå…¨ãƒ¢ãƒƒã‚¯
2. **Cloudflare Workerså¯¾å¿œ**: Durable Objectsã€Response/Headers/Requestã‚¯ãƒ©ã‚¹ã®å®Œå…¨ãƒ¢ãƒƒã‚¯
3. **äººç‹¼ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ãƒ†ã‚¹ãƒˆ**: å½¹è·å‰²ã‚Šå½“ã¦ã€ãƒ•ã‚§ãƒ¼ã‚ºé·ç§»ã€AIæ©Ÿèƒ½ã®åŒ…æ‹¬çš„ãƒ†ã‚¹ãƒˆ
4. **CORSæ©Ÿèƒ½å®Œå…¨ãƒ†ã‚¹ãƒˆ**: addCorsHeadersé–¢æ•°ã®å®Œå…¨å‹•ä½œç¢ºèª
5. **Property-Based TestingåŸºç›¤**: fast-checkãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯å°å…¥æ¸ˆã¿
6. **TDDå®Ÿè·µ**: å…¨ã‚³ãƒ¼ãƒ‰å¤‰æ›´ã«å¯¾å¿œã™ã‚‹ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿè£…

#### ãƒ†ã‚¹ãƒˆæŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯
- **Jest**: TypeScriptå¯¾å¿œãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯
- **fast-check**: Property-Based Testing
- **ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒƒã‚¯**: WebSocketã€HTTPã€Cloudflare Workers API
- **TypeScript**: å‹å®‰å…¨ãƒ†ã‚¹ãƒˆå®Ÿè£…
- **ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆ**: è©³ç´°ãªã‚³ãƒ¼ãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸åˆ†æ

#### ä¸»è¦ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«è©³ç´°

##### `packages/workers/src/__tests__/utils.test.ts` (21ãƒ†ã‚¹ãƒˆ - 100%æˆåŠŸ)
- **generateRoomId**: ãƒ«ãƒ¼ãƒ IDç”Ÿæˆã®ä¸€æ„æ€§ãƒ»å½¢å¼æ¤œè¨¼
- **validatePlayerName**: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆæ—¥æœ¬èªãƒ»è‹±æ•°å­—å¯¾å¿œï¼‰
- **validateRoomId**: ãƒ«ãƒ¼ãƒ IDå½¢å¼æ¤œè¨¼
- **createApiResponse**: APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”Ÿæˆãƒ†ã‚¹ãƒˆ
- **addCorsHeaders**: CORSæ©Ÿèƒ½å®Œå…¨ãƒ†ã‚¹ãƒˆ
- **çµ±åˆãƒ†ã‚¹ãƒˆ**: ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ã‚·ãƒŠãƒªã‚ªæ¤œè¨¼

##### `packages/workers/src/__tests__/gameRoom.test.ts` (19ãƒ†ã‚¹ãƒˆ - 100%æˆåŠŸ)
- **WebSocketå®Œå…¨ãƒ¢ãƒƒã‚¯**: MockWebSocket, MockWebSocketPairã‚¯ãƒ©ã‚¹
- **HTTPå‡¦ç†ãƒ†ã‚¹ãƒˆ**: WebSocketã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ï¼ˆstatus 101å¯¾å¿œï¼‰
- **ã‚²ãƒ¼ãƒ çŠ¶æ…‹ç®¡ç†**: ãƒ•ã‚§ãƒ¼ã‚ºé·ç§»ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç†
- **AIæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ**: AIPersonalityã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã€è‡ªå‹•è¡Œå‹•
- **ã‚¿ã‚¤ãƒãƒ¼å‡¦ç†**: jest.useFakeTimersã«ã‚ˆã‚‹ã‚¿ã‚¤ãƒãƒ¼ãƒ†ã‚¹ãƒˆ
- **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: ç„¡åŠ¹ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†

#### ãƒ†ã‚¹ãƒˆå“è³ªæŒ‡æ¨™
- **å…¨ãƒ†ã‚¹ãƒˆæˆåŠŸç‡**: 100% (40/40ãƒ†ã‚¹ãƒˆ)
- **utils.ts ã‚«ãƒãƒ¬ãƒƒã‚¸**: 100% (Statement, Branch, Function, Line)
- **å‹å®‰å…¨æ€§**: TypeScriptå®Œå…¨å¯¾å¿œ
- **ãƒ¢ãƒƒã‚¯å“è³ª**: Cloudflare Workers APIå®Œå…¨äº’æ›

#### æŠ€è¡“çš„æˆæœ
1. **æ®µéšçš„ã‚¨ãƒ©ãƒ¼è§£æ±º**: TypeScriptã€Jestè¨­å®šã€WebSocketãƒ¢ãƒƒã‚¯å®Ÿè£…
2. **å®Œå…¨ãªCORSå®Ÿè£…**: Access-Control-Allow-Originç­‰ã®ãƒ˜ãƒƒãƒ€ãƒ¼å‡¦ç†
3. **WebSocketæ©Ÿèƒ½å®Œå…¨ãƒ†ã‚¹ãƒˆ**: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡ã®åŒ…æ‹¬çš„æ¤œè¨¼
4. **äººç‹¼ã‚²ãƒ¼ãƒ ç‰¹æœ‰ãƒ­ã‚¸ãƒƒã‚¯**: å½¹è·ï¼ˆvillagerã€werewolfã€seerã€mediumã€hunterã€madmanï¼‰ã®å®Œå…¨ãƒ†ã‚¹ãƒˆ

#### å°†æ¥ã®æ‹¡å¼µå¯èƒ½æ€§
- Property-Based Testing (gameRoom.pbt.test.ts) ã®å†æœ‰åŠ¹åŒ–
- gameRoom.ts ã®ã•ã‚‰ãªã‚‹ã‚«ãƒãƒ¬ãƒƒã‚¸å‘ä¸Š
- E2Eãƒ†ã‚¹ãƒˆã®è¿½åŠ 
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã®å®Ÿè£…

ç¾åœ¨ã€äººç‹¼ã‚²ãƒ¼ãƒ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®é‡è¦ãªæ©Ÿèƒ½ã™ã¹ã¦ãŒé©åˆ‡ã«ãƒ†ã‚¹ãƒˆã•ã‚Œã€é«˜ã„å“è³ªã¨ä¿¡é ¼æ€§ãŒä¿è¨¼ã•ã‚ŒãŸçŠ¶æ…‹ã§ã™ã€‚